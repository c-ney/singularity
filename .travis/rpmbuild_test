#!/bin/bash -ex

# this script runs as root under docker

# shellcheck source=/dev/null

OS_TYPE="$1"
OS_VERSION="$2"

deps_file=".travis/deps/${OS_TYPE}_${OS_VERSION}_deps"

if [[ -e "${deps_file}" ]]; then
    source "${deps_file}"
else
    echo "OS ${OS_TYPE}, version ${OS_VERSION} not supported yet, please create ${deps_file}!"
    exit 1
fi


# build and install
install_autogen_deps
./autogen.sh

install_configure_deps
./configure
make dist
rpmbuild -ta *.tar.gz

install_rpms

if [ "$OS_VERSION" = 6 ]; then
    echo "the test suite has not yet been ported to centos6 python, skipping."
    exit
fi

install_test_deps

# run the test suite
sed -i 's,^prefix=.*,prefix=/usr,' test.sh
sed -i 's,^sysconfdir=.*,sysconfdir=/etc,' test.sh
sed -i 's,^localstatedir=.*,localstatedir=/var,' test.sh
if [ "$OS_TYPE" = "opensuse" ]; then
    sed -ri 's,(^libexecdir=.*)/.*,\1/lib",' test.sh
fi
useradd --create-home testuser
echo "Defaults:testuser env_keep=DOCKER_HOST" >>/etc/sudoers
echo "testuser ALL=(ALL) NOPASSWD: ALL" >>/etc/sudoers

# build image for isolated builds
sed -i 's,^prefix=.*,prefix=/usr,' secbuildimg.sh
sed -i 's,^sysconfdir=.*,sysconfdir=/etc,' secbuildimg.sh
sed -i 's,^localstatedir=.*,localstatedir=/var,' secbuildimg.sh
if [ "$OS_TYPE" = "opensuse" ]; then
    sed -ri 's,(^libexecdir=.*)/.*,\1/lib",' secbuildimg.sh
fi
make secbuildimg

su testuser -c "make test"
